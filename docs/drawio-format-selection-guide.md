# draw.io 出力形式選択ガイド (v4.3)

## 概要

このドキュメントは、draw.io 編集可能な図面を生成する際の出力形式の選択に関するガイドラインです。

## 🚨 重要な学び（v4.3 で追加）

### 問題：`.drawio.svg` が空白で表示される

`.drawio.svg` 形式では、SVG ファイル内に `content` 属性として mxCell 定義を埋め込みます。しかし、**SVG 描画要素（`<rect>`, `<path>`, `<text>` 等）が空の場合、draw.io で開いても何も表示されません**。

#### 問題が発生するパターン

```xml
<!-- ❌ 問題のあるパターン：SVG描画要素なし -->
<svg xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>/* スタイル定義 */</style>
  </defs>
  <g>
    <!-- content属性にmxCell定義があるが、描画要素がない -->
    <text x="10" y="20" content="%3CmxGraphModel%3E...%3C%2FmxGraphModel%3E"></text>
  </g>
  <!-- <rect>, <path>, <text>などのSVG描画要素が存在しない -->
</svg>
```

#### なぜ問題が起きるか

1. SVG ファイルとしてブラウザで開くと、描画要素がないため何も表示されない
2. draw.io で開くと、`content` 属性を解析して図を再構築するが、処理が正しく行われない場合がある
3. `content` 属性のみでは draw.io が図を再構築できないケースが存在する

## 解決策：`.drawio` (XML) 形式を優先

### 形式比較表

| 形式            | 拡張子        | 推奨度    | 長所                                  | 短所                                     |
| --------------- | ------------- | --------- | ------------------------------------- | ---------------------------------------- |
| **draw.io XML** | `.drawio`     | ✅ 推奨   | 確実に描画、mxCell 構造のみ、小サイズ | ブラウザ直接表示不可                     |
| draw.io SVG     | `.drawio.svg` | ⚠️ 非推奨 | ブラウザ表示可能（理論上）            | content 属性のみでは描画されない場合あり |

### 推奨ワークフロー

```
┌─────────────────────────────────────────────────────────┐
│                    推奨ワークフロー                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│   1. .drawio (XML) 形式で生成                          │
│      ↓                                                  │
│   2. draw.io で開いて確認・編集                        │
│      ↓                                                  │
│   3. SVGが必要な場合:                                   │
│      「ファイル」→「エクスポート」→「SVG」             │
│      → 正式なSVG描画要素を含むファイルが生成される      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 形式選択ルール

### `.drawio` (XML) を使用する場合（推奨）

- **常に優先** - 特に指定がなければ必ず XML 形式を使用
- draw.io での編集が主目的
- 確実に動作する図面が必要
- ファイルサイズを小さく保ちたい

### `.drawio.svg` を使用する場合（非推奨）

- ユーザーが明示的に SVG 形式を要求した場合
- 既存の `.drawio.svg` ファイルを編集する場合
- Web ブラウザでの直接表示が必須の場合（ただし動作保証なし）

## 技術的な詳細

### `.drawio` (XML) の構造

```xml
<!-- ✅ 正しい .drawio ファイル構造 -->
<mxfile host="..." modified="..." agent="..." version="...">
  <diagram id="..." name="Page-1">
    <mxGraphModel dx="..." dy="..." grid="1" ...>
      <root>
        <mxCell id="0"/>                          <!-- ルートセル -->
        <mxCell id="1" parent="0"/>               <!-- デフォルト親 -->
        <mxCell id="node1" value="ノード1" .../>  <!-- 実際のノード -->
        <mxCell id="edge1" source="..." target="..." .../> <!-- エッジ -->
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
```

### `.drawio.svg` の構造（参考：問題のあるパターン）

```xml
<!-- ⚠️ .drawio.svg - content属性のみでは不十分 -->
<svg xmlns="http://www.w3.org/2000/svg" ...>
  <!-- content属性にmxGraphModelがエンコードされている -->
  <!-- しかしSVG描画要素（<rect>, <path>, <text>等）が必要 -->
</svg>
```

## チェックリスト

生成前に確認するべき項目：

- [ ] 出力形式は `.drawio` (XML) を優先しているか？
- [ ] ユーザーから明示的に SVG が要求されていないか？
- [ ] 既存ファイルの編集ではないか？

生成後に確認するべき項目：

- [ ] mxCell の数が期待値と一致しているか？（2 + ノード数 + エッジ数）
- [ ] draw.io で開いて図が正しく表示されるか？
- [ ] 編集可能な状態であるか？

## 関連ドキュメント

- [AGENTS.md](../AGENTS.md) - エージェント構成と運用ルール
- [copilot-instructions.md](../.github/copilot-instructions.md) - Copilot 共通指針
- [svg-forge.agent.md](../.github/agents/svg-forge.agent.md) - SVG Forge エージェント定義
- [drawio-generation-tips.md](./drawio-generation-tips.md) - draw.io 生成のヒント

## 更新履歴

| 日付       | バージョン | 変更内容                                                 |
| ---------- | ---------- | -------------------------------------------------------- |
| 2025-12-12 | 1.0        | 初版作成。.drawio.svg が空白表示になる問題の学びを文書化 |
