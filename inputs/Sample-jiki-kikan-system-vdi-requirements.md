# 次期期間システム VDI 要件定義書

## 1. 概要

- 目的: 次期期間システム向けに、業務ユーザーが場所を問わず安全に業務アプリへアクセスできる仮想デスクトップ基盤をマルチクラウドで実現する。
- 対象: 情報システム部門、セキュリティチーム、運用チーム、ベンダー。
- 前提: オンプレミス拠点と Azure は ExpressRoute 接続、Azure と AWS はサイト間 VPN (Transit Gateway 相当) により閉域/暗号化通信を確保する。
- 成功基準: 遅延 SLO 満たす本番稼働 1 か月継続、重大インシデントゼロ、監査ログ欠損ゼロ、コスト逸脱 ±10% 以内。

## 2. スコープ

- 対象領域: 認証、仮想デスクトップ、プロファイル/ファイル、業務アプリ接続、ネットワーク、運用/監視、BCP/DR。
- 非対象: 既存オンプレミス業務アプリの改修、エンドユーザー端末の調達/MDM 設定。
- 依存関係: オンプレ ID フェデレーション基盤、現行業務アプリ API、社内プロキシ、社内 PKI、有線/無線 LAN 更新計画。
- 制約: 既存 IP アドレス重複不可、個人データ国外持ち出し禁止、業務時間帯メンテ不可 (20-08 時のみ許容)。

## 3. 想定規模

- 同時接続ユーザー: 平常 2,000 名、ピーク 3,000 名。
- 仮想デスクトップ: Standard (4 vCPU/16 GB) を基本、開発者向けに High (8 vCPU/32 GB) を 10% 用意。
- ストレージ: プロファイル 50 GB/人、業務ファイル共有 20 TB から開始。
- 帯域試算: 平均 1 Mbps/セッション、ピーク 3 Gbps (冗長回線で 50%/50% 分散)。

## 4. 機能要件

- VDI 基盤: Azure Virtual Desktop (AVD) を主、AWS WorkSpaces を DR/補完用途で最小構成起動可能とする。
- ディレクトリ/ID: Azure AD (Entra ID) を中核、AWS は IAM Identity Center 連携でフェデレーション。MFA 必須。
- プロファイル管理: FSLogix + Azure Files Premium (汎用) を主、AWS 側は FSx for Windows File Server を待機系で用意。
- アプリ配信: AVD MSIX app attach を優先、Fat クライアントはゴールデンイメージ/イメージ管理で月次パッチ。
- 印刷/USB: ポリシーで制限。特例は仮想プリンタのみ許可。
- インターネット分離: セッションから直接は不可。Web アクセスはプロキシ経由 (Azure Firewall + ID ベース制御) でログ取得。
- 監査/操作ログ: AVD 診断ログと OS セキュリティログを Log Analytics に集約、AWS 側は CloudWatch Logs へ。最低 365 日保管。
- 接続方式: AVD RDP Shortpath (UDP) を既定、Fallback は TCP。WorkSpaces は WSP 利用。
- クライアント要件: Windows 10/11, macOS 最新 2 バージョン、モバイルは会社支給端末のみ許可。
- 業務アプリ接続: オンプレ/クラウド双方の業務 API へ到達できること。SMB 共有は Azure Files/FSx のみ許可。

## 5. 非機能要件

- 可用性: 業務時間帯 (平日 8-20 時) 99.9% を目標。
- 性能: 主要業務操作のラウンドトリップ遅延 150 ms 以下、画面フリーズ < 1 秒/操作。
- 拡張性: ピーク時 3,000 セッションを 30 分以内にスケールアウト可能。
- バックアップ: プロファイル/共有ファイルは日次スナップショット保持 30 日、週次 8 週、月次 12 か月。
- 運用: パッチは月次定例 (第 2 週)、緊急時は 48 時間以内適用。
- 可観測性: 主要メトリクス (CPU、メモリ、ログオン遅延、FSLogix 確立時間、ネットワーク遅延) を 1 分粒度で収集し、14 日間はホット保存。
- セッション UX: 初回ログオン 60 秒以内、再接続 15 秒以内、アプリ起動 10 秒以内。

## 6. アーキテクチャ概要

- ハブ&スポーク (Azure 主): Hub VNet に Azure Firewall、AVD 管理、ExpressRoute Gateway、VPN Gateway を配置。スポーク VNet に AVD セッションホスト。AWS 側は VPC + Transit Gateway + VGW を用い、Azure VPN Gateway と IPsec/BGP で接続。
- 通信経路:
  - オンプレ → (ExpressRoute) → Azure Hub → AVD/業務アプリ。
  - Azure Hub → (IPsec VPN/BGP) → AWS TGW → AWS WorkSpaces/FSx。
- DNS: Azure Private DNS を主、AWS Route 53 Resolver とフォワーダで双方向解決。SPOF 回避のため二重化。
- ルーティング: BGP による経路交換。オンプレ優先ルート、AWS は 2 次経路。Split tunneling を実施し、インターネット向けはプロキシ経由。
- ゲートウェイ構成: ExpressRoute Gateway は ErGw3AZ、VPN Gateway は VpnGw2AZ 以上を想定。AWS TGW はマルチ AZ。
- 監査/ゼロトラスト: 管理プレーンは JIT + Privileged Access Workstation 経由、ユーザープレーンとは分離。

## 7. セキュリティ要件

- 認証/認可: Entra ID + Conditional Access。端末コンプライアンス必須 (Intune)。特権は PIM。
- ネットワーク: East/West は NSG/Firewall で最小許可。TLS1.2 以上、SMB3 暗号化有効。
- データ保護: BitLocker (OS/データ), Azure Files/FSx 暗号化 at rest, 伝送は IPsec/TLS。
- 監査: 管理操作は Azure Activity Logs + AWS CloudTrail を集中保存し、Immutable 保管 (Storage with versioning/WORM)。
- 検疫: 未管理端末・脆弱端末は接続不可。AVD ログオン前に CA によるデバイスコンプライアンスチェックを実施。
- 電子証明書: クライアント証明書による VPN/プロキシ強制。期限切れ 14 日前から警告。
- 権限分離: 運用/監視/セキュリティ/アプリ配布で RBAC 分離。

## 8. ネットワーク要件

- アドレス設計: Azure 10.10.0.0/16 (Hub 10.10.0.0/20, Spoke 10.10.16.0/20)、AWS 10.20.0.0/16。オンプレと重複禁止。
- 帯域: ExpressRoute Premium 1 Gbps 以上、VPN IPsec トンネルは 2 本で冗長 (各 1 Gbps 想定)。
- 冗長: ER Gateway Active/Active、VPN Gateway Active/Active、AWS TGW 2 AZ 配置。
- QoS: AVD 制御ポート/UDP を優先キュー。バックアップは夜間帯に帯域制御。
- BGP 設定: Azure ASN 65010、AWS ASN 65020、オンプレ ASN 65000。BGP keepalive 30 秒、hold 90 秒。
- DNS レイテンシ: フォワーダ遅延 30 ms 以内。キャッシュ TTL は業務要件に合わせ 300 秒目安。

## 9. BCP/DR

- DR 方針: Azure 東京/東日本リージョン間で AVD セッションホストを DR スタンバイ。AWS ap-northeast-1 は最終バックアップ退避・代替 WorkSpaces 起動。
- 目標: RTO 4 時間、RPO 1 時間 (プロファイル/ファイルはスナップショット + geo 冗長)。
- 手順: フェイルオーバー runbook を自動化 (Azure Automation/Logic Apps)。四半期ごとに DR リハーサル。
- フェイルバック: 本番復旧後 24 時間以内にプライマリへ戻す手順を runbook 化。
- データ一貫性: FSLogix/ファイルはストレージレプリケーション整合性を確認してから切替。

## 10. 運用・監視

- 監視: Azure Monitor + Log Analytics、AWS CloudWatch で CPU/メモリ/ログイン/FSLogix エラーを可視化。閾値超過は Teams/Slack 通知。
- 構成管理: IaC (Bicep/Terraform) でネットワーク・AVD ホストプールをコード化。AMI/イメージは Packer 管理。
- キャパ計画: 月次で利用率をレビューしホストプール台数を調整。
- 障害対応: インシデント分類 (P1-P4)、P1 は 15 分以内初動、60 分以内暫定回復、RCA 48 時間以内。
- 変更管理: 週次 CAB、標準変更 (AVD ホスト追加) は自動承認、緊急変更は事後レビュー必須。
- ログ保持: セキュリティログ 365 日、監視メトリクス 90 日、フル監査証跡はアーカイブで 3 年保管。

## 11. マイグレーション/リリース計画 (概要)

- パイロット: 100 名で 2 週間。パフォーマンス/UX/印刷を検証。
- 段階展開: 部門単位で 4 フェーズ。フェーズごとにピーク 25% ずつ移行。
- カットオーバー判定: 成功基準 (遅延 < 150 ms, 接続成功率 > 99.5%, ログ欠損なし)。
- データ移行: プロファイルは FSLogix コンテナ移行、ファイル共有はストレージ同期後にスイッチ。
- トレーニング: ユーザー向け 30 分オンライン動画、IT サポート向け 2 時間ハンズオン。

## 12. リスクと対応

- ネットワーク遅延: 近接リージョン選定、UDP 最適化、QoS 実装。
- ID フェデレーション障害: CA ポリシー緩和手順と緊急ローカルアカウントを準備。
- コスト超過: 自動スケール/スケジュール停止、Reserved Instance 検討。
- サプライチェーン: マーケットプレイスイメージは署名確認。ドライバはベンダー署名のみ。
- ランサム対策: 重要共有は不変ストレージでスナップショット保護、Egress 制限。

## 14. 役割と責任 (RACI 抜粋)

- ID/認証: セキュリティ (A), IT 運用 (R), ベンダー (C), 事業部 (I)
- ネットワーク/接続: ネットワークチーム (R/A), セキュリティ (C), ベンダー (C)
- AVD 運用: IT 運用 (R), セキュリティ (C), ベンダー (C), 事業部 (I)
- DR テスト: IT 運用 (R), セキュリティ (C), 事業部 (C), ベンダー (I)

## 15. テスト計画 (要約)

- 性能テスト: ログオン 500 セッション/10 分、アプリ起動 1,000 リクエスト/30 分で遅延測定。
- フェイルオーバー: ExpressRoute 切断時は VPN 迂回で業務継続を確認。AWS 切断時は Azure 単独で業務継続を確認。
- セキュリティテスト: CA ポリシー回避試行、FSLogix 不正アクセス試行、ログ改ざん検証。

## 16. 用語

- AVD: Azure Virtual Desktop
- ER: ExpressRoute
- TGW: Transit Gateway
- CA: Conditional Access
- PIM: Privileged Identity Management

## 17. キャパシティ/サイジング (初期モデル)

- セッションホスト密度: Standard (4 vCPU/16 GB) で 16-20 セッション/台、High (8 vCPU/32 GB) で 24-28 セッション/台を目安。CPU/メモリいずれか 75% でスケールアウト。
- 台数計算 (平常時): 2,000 セッション / 18 平均 = 約 112 台 (ゾーン冗長で 2 AZ 均等)。ピーク時 3,000 セッションで約 168 台。
- ストレージ IOPS: プロファイルは 8 IOPS/セッション想定で 24k IOPS。Azure Files Premium/FSx は帯域と IOPS を SKU で満たすこと。
- 帯域: AVD セッション 1 Mbps/平均で 2 Gbps (平常)、3 Gbps (ピーク)。ログ/バックアップ帯域は夜間に制御。
- スケール戦略: 起動バッファ 15% を常時確保、業務開始 60 分前にプリスケール、終業後に段階的縮退。

## 18. SLO/SLI/SLA

- 利用時間: 平日 08:00-20:00 をコア。SLO 可用性 99.9%。
- 性能 SLI: ログオン時間 P95 60 秒以下、再接続 P95 15 秒以下、アプリ起動 P95 10 秒以下、Round-trip latency P95 150 ms 以下。
- 接続成功率: P99.5 以上 (認証成功 + セッション確立)。
- DR SLO: フェイルオーバー完了 240 分以内、データ RPO 60 分以内。
- アラート: SLO 逸脱予兆 (P90 逼迫) でプレアラート、P95 越えで運用当番エスカレーション。

## 19. コンプライアンス/プライバシー

- 個人データ保護: データ所在は国内リージョン優先。国外レプリカはハッシュ化/匿名化のみ許容。
- ログマスキング: 個人識別情報を含むログは KQL でマスキングビューを適用。
- 監査証跡: 管理操作は WORM/immutable ストレージで 3 年保管。アクセスはブレークグラス経由のみ。
- 標準準拠 (例): ISO 27001, SOC 2 Type II, CIS ベンチマーク準拠を目標。差分は是正計画を 30 日以内に作成。

## 20. 運用ランブック (抜粋)

- RB-01: ExpressRoute 障害時の VPN 迂回切替手順。
- RB-02: AVD ホストプール急増時のスケールアウト/キャパ確保手順。
- RB-03: FSLogix ログオン失敗時のトラブルシュート (ストレージ帯域/セッション制限/権限確認)。
- RB-04: DR 発動・フェイルオーバー・フェイルバック手順。
- RB-05: 証明書更新/失効対応、CA ポリシー緩和の緊急手順。

## 21. 未決/前提の確認事項

- オンプレ ID 基盤の可用性/SLA と CA ポリシー適用範囲。
- 既存業務アプリの帯域/ポート要件と TCP/UDP 動作性。
- 端末標準イメージと周辺機器 (スマートカード/プリンタ) の対応可否。
- コンプライアンス上のデータ所在制約 (海外 DR の可否)。
- 運用体制: 24/365 か時間限定か、一次/二次/三次エスカレーション先。

## 22. コスト見積 (概算・月額目安)

### Azure 側 (主系)

| 項目                                     | SKU/数量                 | 月額概算 (税抜)   |
| ---------------------------------------- | ------------------------ | ----------------- |
| AVD セッションホスト (Standard D4s v5)   | 112 台 × 730 h (RI 1 年) | ¥4,200,000        |
| AVD セッションホスト (バッファ/ピーク用) | 60 台 × 200 h (従量)     | ¥800,000          |
| Azure Files Premium (100 TiB)            | 100 TiB                  | ¥1,500,000        |
| ExpressRoute Premium (1 Gbps)            | 1 回線                   | ¥350,000          |
| VPN Gateway (VpnGw2AZ)                   | 2 台 (Active/Active)     | ¥120,000          |
| Azure Firewall Premium                   | 1 台                     | ¥250,000          |
| Log Analytics (500 GB/日)                | 500 GB × 30 日           | ¥600,000          |
| Azure Monitor / Alerts                   | -                        | ¥50,000           |
| **Azure 小計**                           |                          | **約 ¥7,870,000** |

### AWS 側 (DR/補完)

| 項目                              | SKU/数量         | 月額概算 (税抜) |
| --------------------------------- | ---------------- | --------------- |
| WorkSpaces (Standard, 待機 50 台) | 50 台 × AlwaysOn | ¥400,000        |
| FSx for Windows (2 TiB)           | 2 TiB SSD        | ¥150,000        |
| Transit Gateway + VPN             | 2 トンネル       | ¥80,000         |
| CloudWatch Logs (100 GB/日)       | 100 GB × 30 日   | ¥100,000        |
| **AWS 小計**                      |                  | **約 ¥730,000** |

### 合計

| 区分     | 月額              |
| -------- | ----------------- |
| Azure    | ¥7,870,000        |
| AWS      | ¥730,000          |
| **合計** | **約 ¥8,600,000** |

※ 為替・価格改定・消費税は別途。RI/Savings Plans 適用前の概算。

## 23. プロジェクト体制

### 組織図 (簡易)

```
プロジェクトオーナー (事業部長)
    │
プロジェクトマネージャー (IT部)
    ├── インフラリード (ネットワーク/クラウド)
    │       ├── Azure 担当
    │       └── AWS 担当
    ├── セキュリティリード
    ├── 運用リード
    └── ベンダー PM
```

### 主要役割

| 役割                 | 担当           | 責務                                  |
| -------------------- | -------------- | ------------------------------------- |
| プロジェクトオーナー | 事業部長       | 最終意思決定、予算承認                |
| PM                   | IT 部課長      | 進捗/リスク管理、ステークホルダー調整 |
| インフラリード       | IT 部主任      | 設計/構築、IaC 管理                   |
| セキュリティリード   | セキュリティ部 | ポリシー策定、監査対応                |
| 運用リード           | IT 運用チーム  | 運用設計、ランブック整備              |
| ベンダー PM          | SIer           | 実装支援、技術サポート                |

## 24. スケジュール (マスタ)

| フェーズ         | 期間            | 主要マイルストーン                           |
| ---------------- | --------------- | -------------------------------------------- |
| 要件定義         | M1-M2 (8 週)    | 要件凍結、RFP 発行                           |
| 基本設計         | M3-M4 (8 週)    | アーキテクチャ承認、セキュリティレビュー完了 |
| 詳細設計         | M5 (4 週)       | IaC テンプレート完成、テスト計画承認         |
| 構築・単体テスト | M6-M8 (12 週)   | 環境構築完了、単体テスト完了                 |
| 結合・性能テスト | M9-M10 (8 週)   | 性能 SLO 達成確認、DR リハーサル完了         |
| パイロット       | M11 (4 週)      | パイロット 100 名完了、Go/No-Go 判定         |
| 段階展開         | M12-M14 (12 週) | フェーズ 1-4 順次移行                        |
| 本番安定化       | M15 (4 週)      | SLO 1 か月達成、プロジェクト完了報告         |

**総期間: 約 15 か月**

## 25. 承認・改訂履歴

| 版  | 日付       | 作成者 | 承認者 | 変更内容     |
| --- | ---------- | ------ | ------ | ------------ |
| 0.1 | 2025-12-10 | IT 部  | -      | 初版ドラフト |
| 0.2 | (予定)     | IT 部  | PM     | レビュー反映 |
| 1.0 | (予定)     | IT 部  | PO     | 正式版承認   |

## 26. 添付資料 (別紙)

| No  | 資料名             | 説明                                     |
| --- | ------------------ | ---------------------------------------- |
| A-1 | ネットワーク構成図 | Hub/Spoke/AWS 接続トポロジ               |
| A-2 | IP アドレス設計書  | CIDR、サブネット割当                     |
| A-3 | セキュリティ設計書 | NSG/Firewall ルール、CA ポリシー         |
| A-4 | 運用設計書         | 監視項目、アラート閾値、エスカレーション |
| A-5 | DR 手順書          | フェイルオーバー/フェイルバック runbook  |
| A-6 | テスト計画書       | テストケース、合格基準                   |
| A-7 | 移行計画書         | 部門別スケジュール、データ移行手順       |

## 27. 参考情報

- ExpressRoute と VPN 共存設計: https://learn.microsoft.com/en-us/azure/expressroute/expressroute-howto-coexist-resource-manager#before-you-begin
- BGP 有効な VPN 接続: https://learn.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-3rdparty-device-config-overview#single-vpn-tunnel
- Azure Virtual Desktop ドキュメント: https://learn.microsoft.com/ja-jp/azure/virtual-desktop/
- FSLogix ベストプラクティス: https://learn.microsoft.com/ja-jp/fslogix/overview
- AWS WorkSpaces 管理ガイド: https://docs.aws.amazon.com/workspaces/latest/adminguide/
- AWS Transit Gateway: https://docs.aws.amazon.com/vpc/latest/tgw/
